language: python

python:
  - '3.5'
  - '3.7'

services:
  - postgresql
  - docker

addons:
  postgresql: '10'
  apt:
    packages:
    - postgresql-10
    - postgresql-client-10

env:
  global:
  - DATABASE_URL='postgres://postgres@localhost/usaspending_api'
  - DJANGO_SETTINGS_MODULE='usaspending_api.settings'
  - ES_HOSTNAME='http://localhost:9200'
  - DATA_BROKER_DATABASE_URL='postgres://admin:root@localhost:5435/data_broker'
  - BROKER_REPO_FOLDER=${TRAVIS_BUILD_DIR}/../data-act-broker-backend

before_install:
  - npm install dredd@5.4.1 --global

install:
  - if [[ $TRAVIS_PYTHON_VERSION == '3.7' ]]; then travis_retry pip install -r requirements/requirements_3-7.txt; else travis_retry pip install -r requirements/requirements.txt; fi
  - pip install coveralls
  # Checkout dependent broker code used to spin up a broker integration test db. Put it in its own folder alongside this repo's code
  - git clone --branch development --single-branch --depth 1 https://github.com/fedspendingtransparency/data-act-broker-backend.git ${BROKER_REPO_FOLDER}

before_script:
  - curl -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.1.1.deb && sudo dpkg -i --force-confnew elasticsearch-6.1.1.deb && sudo service elasticsearch restart
  - psql -c "CREATE DATABASE usaspending_api;" -U postgres
  - psql -c "CREATE USER readonly;"
  - python manage.py migrate
  - sleep 10  # recommended by Travis to ensure Elasticsearch has time to spin up
  # Spin up Broker database in a container for ETL integration tests
  - cd ${BROKER_REPO_FOLDER}
  - docker-compose up -d dataact-broker-db
  - sleep 10  # wait for Postgres to be up
  - cp dataactcore/config_example.yml dataactcore/config.yml
  - cp dataactcore/local_config_example.yml dataactcore/local_config.yml
  - cp dataactcore/local_config_secrets.yml dataactcore/local_secrets.yml
  - cat requirements.txt | grep -Ei 'alembic|PyYAML|Flask|psycopg2' > requirements-alembic.txt
  - docker run --init --rm --name=dataact-broker-init-integrationtest-db -e PYTHONPATH=/data-act/backend -w /data-act/backend --mount type=bind,source="$(pwd)",target=/data-act/backend python:3.5 /bin/sh -c "pip install -r requirements-alembic.txt && cd ./dataactcore; alembic upgrade head"

script:
  - cd ${TRAVIS_BUILD_DIR}
  - flake8
  - if [[ $TRAVIS_PYTHON_VERSION == '3.7' ]]; then black --check . ; fi
  - python manage.py check_for_endpoint_documentation
  - pytest --ignore-glob='**/tests/integration/*' --cov=usaspending_api
  - pytest --override-ini=python_files='**/tests/integration/test_*.py **/tests/integration/*_test.py' --cov=usaspending_api --cov-append --cov-report term
  # - dredd  (Disable dredd until test data is loaded into DB for API responses)

after_success:
  - codeclimate-test-reporter
